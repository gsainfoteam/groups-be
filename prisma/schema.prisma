generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider            = "prisma-dbml-generator"
  projectName         = "vapor_auth_be"
  projectDatabaseType = "PostgreSQL"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Authority {
  MEMBER_UPDATE
  MEMBER_DELETE
  ROLE_CREATE
  ROLE_UPDATE
  ROLE_DELETE
  GROUP_UPDATE
  GROUP_DELETE
}

model User {
  uuid      String   @id @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  groups      UserGroup[]
  roles       UserRole[]
  ownedGroups Group[]

  @@map("user")
}

model Group {
  uuid          String   @id @db.Uuid
  name          String   @unique
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")
  presidentUuid String   @map("president_uuid") @db.Uuid

  president User @relation(fields: [presidentUuid], references: [uuid])

  users     UserGroup[]
  roles     Role[]
  userRoles UserRole[]

  @@map("group")
}

model UserGroup {
  userUuid  String   @map("user_uuid") @db.Uuid
  User      User     @relation(fields: [userUuid], references: [uuid])
  groupUuid String   @map("group_uuid") @db.Uuid
  Group     Group    @relation(fields: [groupUuid], references: [uuid], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@id([userUuid, groupUuid])
  @@map("user_group")
}

model Role {
  id                  Int
  name                String
  groupUuid           String      @map("group_uuid") @db.Uuid
  Group               Group       @relation(fields: [groupUuid], references: [uuid], onDelete: Cascade)
  authorities         Authority[] @map("authorities")
  externalAuthorities String[]    @map("external_authorities")

  userRoles UserRole[]

  @@id([id, groupUuid])
  @@unique([name, groupUuid])
}

model UserRole {
  userUuid  String @map("user_uuid") @db.Uuid
  User      User   @relation(fields: [userUuid], references: [uuid])
  groupUuid String @map("group_uuid") @db.Uuid
  Group     Group  @relation(fields: [groupUuid], references: [uuid], onDelete: Cascade)
  roleId    Int    @map("role_id")
  Role      Role   @relation(fields: [roleId, groupUuid], references: [id, groupUuid], onDelete: Cascade)

  @@id([userUuid, groupUuid])
  @@map("user_role")
}
